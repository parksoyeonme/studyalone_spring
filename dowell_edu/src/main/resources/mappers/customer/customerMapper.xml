<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="customer">
   
   <resultMap type="com.dowell.edu.vo.common.PartnerVO" id="PartnerVO">
    	<result column="prt_nm" property="prt_nm"/>
   
	</resultMap>
	
	<resultMap type="com.dowell.edu.vo.customer.CustomerVO" id="CustomerVO">
    	<result column="cust_no" property="cust_no"/>
    	<result column="cust_nm" property="cust_nm"/>
    	<result column="mbl_no" property="mbl_no"/>
    	<result column="cust_ss_cd" property="cust_ss_cd"/>
    	<result column="fst_js_dt" property="fst_js_dt"/>
    	<result column="lst_upd_id" property="lst_upd_id"/>
    	<result column="lst_upd_dt" property="lst_upd_dt"/>
    	<result column="lst_upd_dt_time" property="lst_upd_dt_time"/>
    	<result column="cust_nm_real" property="cust_nm_real"/>
   			<collection property="partnerVO" resultMap="PartnerVO"/>
	</resultMap>
	
	
	
   <!-- 고객조회(팝업) -->
   <select id="selectcustSearchList" resultType="com.dowell.edu.vo.customer.CustomerVO" parameterType="Map">
	    select cust_no,cust_nm, mbl_no,
	    		   case when cust_ss_cd ='10' then '정상'
	    			when cust_ss_cd ='80' then '중지'
	    			else '해지'
	    			end as cust_ss_cd
	    from CS_CUST01_MT
	    where 1=1
	    <if test="mbl_no.equals('')">
	        and cust_nm like '%' || #{cust_nm} || '%'
	    </if>
	    <if test="cust_nm.equals('')">
	        and mbl_no like '%' || #{mbl_no} || '%'
	    </if>
	    <if test="!cust_nm.equals('') and !mbl_no.equals('')">
	        and mbl_no like '%' || #{mbl_no} || '%'
	        and cust_nm like '%' || #{cust_nm} || '%'
	    </if>
	</select>
	
	<!-- 고객리스트 -->
	<select id="selectcustAllSearchList" resultMap="CustomerVO">
	    select csmt.cust_no,
	    		csmt.cust_nm as cust_nm_real
	    		, <![CDATA[
	    		case when length(csmt.cust_nm) = 3 then SUBSTR(csmt.cust_nm,1,1) || LPAD('*',LENGTH(csmt.cust_nm)-2,'*') || SUBSTR(csmt.cust_nm, LENGTH(csmt.cust_nm), 1)
	    			when length(csmt.cust_nm) > 3 then SUBSTR(csmt.cust_nm,1,2) || LPAD('*',LENGTH(csmt.cust_nm)-2,'*') || SUBSTR(csmt.cust_nm, LENGTH(csmt.cust_nm), 1)
					else SUBSTR(csmt.cust_nm,1,1) || LPAD('*',LENGTH(csmt.cust_nm)-2,'*')
					  end cust_nm 
					  ]]>
   		        ,REGEXP_REPLACE(REGEXP_REPLACE(csmt.mbl_no, '(.{3})(.*)(.{4})', '\1-\2-\3'), '-(.*)-', '-'||LPAD('*',LENGTH(REGEXP_REPLACE(csmt.mbl_no, '(.{3})(.*)(.{4})', '\2')), '*')||'-') mbl_no
   		        ,case when csmt.cust_ss_cd ='10' then '정상'
   		        	  when csmt.cust_ss_cd ='80' then '중지'
   		        	  when csmt.cust_ss_cd ='90' then '해지'
   		        	  else '전체'
   		        	end as cust_ss_cd
   		        ,to_char(to_date(csmt.fst_js_dt,'YYMMDD'),'YYYY-MM-DD') fst_js_dt
   		        ,PRTMT.prt_nm
   		        ,csmt.lst_upd_id
   		        ,To_CHAR(csmt.lst_upd_dt, 'YYYY-MM-DD HH24MISS') as lst_upd_dt_time
   			from cs_cust01_mt csmt join MA_PRT_MT PRTMT
   				on csmt.jn_prt_cd = prtmt.prt_cd
	    <choose>
   	        <when test="jn_prt_cd.equals('') and cust_no.equals('')">
          		where 
     				fst_js_dt between to_date(#{fromDate},'YYYY-MM-DD')
     						and to_date(#{toDate},'YYYY-MM-DD')
				       <if test="cust_ss_cd gte 10">
				       		and csmt.cust_ss_cd = #{cust_ss_cd}
				       </if>
	        </when>
	        <when test="jn_prt_cd.equals('') and !cust_no.equals('')">
	            where 
       				cust_no = #{cust_no}
      				<if test="cust_ss_cd gte 10">
			      		and csmt.cust_ss_cd = #{cust_ss_cd}
			      	</if>
       				and fst_js_dt between to_date(#{fromDate},'YYYY-MM-DD')
       				and to_date(#{toDate},'YYYY-MM-DD')
	        </when>
	        <when test="cust_no.equals('') and !jn_prt_cd.equals('')">
	            where jn_prt_cd = #{jn_prt_cd}
       				<if test="cust_ss_cd gte 10">
				     	and csmt.cust_ss_cd = #{cust_ss_cd}
				    </if>
       				and fst_js_dt between to_date(#{fromDate},'YYYY-MM-DD')
       				and to_date(#{toDate},'YYYY-MM-DD')
	        </when>
	
	        <otherwise>
	            where jn_prt_cd = #{jn_prt_cd}
   					<if test="cust_ss_cd gte 10">
				     	and csmt.cust_ss_cd = #{cust_ss_cd}
				    </if>
   					and fst_js_dt between to_date(#{fromDate},'YYYY-MM-DD')
   					and to_date(#{toDate},'YYYY-MM-DD')
	        </otherwise>
	    </choose>
	</select>
	
	
	<!--고객이력(팝업)  -->
	<select id="selectcustHistoryList" resultMap="CustomerHistoryVO" resultType="com.dowell.edu.vo.customer.CustomerHistoryVO" parameterType="Map">
		SELECT 
			chg_seq,
		    chg_dt,
		    code_nm,
		    nvl(chg_bf_cd_nm, chg_bf_cnt) AS chg_bf_cnt,
		    nvl(chg_aft_cd_nm, chg_aft_cnt) AS chg_aft_cnt,
		    lst_upd_id,
		    lst_upd_dt_time
		FROM
		    (
		        SELECT
		        	 csht.chg_seq,
		            csht.cust_no,
		            to_char(to_date(csht.chg_dt, 'YYMMDD'), 'YYYY-MM-DD') chg_dt,
		            (
		                SELECT
		                    allcom.comments
		                FROM
		                    all_col_comments allcom
		                WHERE
		                    table_name = 'CS_CUST01_MT'
		                    AND csht.chg_cd = allcom.column_name
		            ) AS code_nm,
		            (
		                SELECT
		                    cddt.dtl_cd_nm
		                FROM
		                    ma_code_dt cddt
		                WHERE
		                    cddt.dtl_cd = csht.chg_bf_cnt
		                    AND cddt.code_cd = csht.chg_cd
		            ) AS chg_bf_cd_nm,
		            
		            CASE
		                WHEN csht.chg_cd = 'MBL_NO'    THEN
		                    regexp_replace(csht.chg_bf_cnt, '(.{3})(.+)(.{4})', '\1-\2-\3')
		                WHEN csht.chg_cd = 'JN_PRT_CD' THEN
		                    (
		                        SELECT
		                            prtmt.prt_nm
		                        FROM
		                            ma_prt_mt prtmt
		                        WHERE
		                            csht.chg_bf_cnt = prtmt.prt_cd
		                    )
		                ELSE csht.chg_bf_cnt
		            END as chg_bf_cnt,
		            (
		                SELECT
		                    cddt.dtl_cd_nm
		                FROM
		                    ma_code_dt cddt
		                WHERE
		                    cddt.dtl_cd = csht.chg_aft_cnt
		                    AND cddt.code_cd = csht.chg_cd
		            ) AS chg_aft_cd_nm,
		            
		            CASE
		                WHEN csht.chg_cd = 'MBL_NO' THEN 
		                		regexp_replace(csht.chg_aft_cnt, '(.{3})(.+)(.{4})', '\1-\2-\3')
		                WHEN csht.chg_cd = 'JN_PRT_CD' THEN
		                    (
		                        SELECT
		                            prtmt.prt_nm
		                        FROM
		                            ma_prt_mt prtmt
		                        WHERE
		                            csht.chg_aft_cnt = prtmt.prt_cd
		                    )
		                ELSE csht.chg_aft_cnt
		            END as chg_aft_cnt,
		            
		            csht.lst_upd_id,
		            To_CHAR(csht.lst_upd_dt, 'YYYY-MM-DD HH24MISS') as lst_upd_dt_time
		        FROM
		            sd_cust01_ht csht
		            LEFT JOIN ma_code_dt cddt ON csht.chg_cd = cddt.code_cd
		            LEFT JOIN all_col_comments allcom ON csht.chg_cd = allcom.column_name
		            LEFT JOIN ma_prt_mt prtmt ON csht.chg_bf_cnt = prtmt.prt_cd
		     ) aa
				where aa.cust_no = #{cust_no}
				order by chg_dt asc ,chg_seq asc
					
	</select>
	
	<resultMap type="com.dowell.edu.vo.customer.CustomerHistoryVO" id="CustomerHistoryVO">
    	<result column="cust_no" property="cust_no"/>
    	<result column="chg_dt" property="chg_dt"/>
    	<result column="chg_seq" property="chg_seq"/>
    	<result column="chg_cd" property="chg_cd"/>
    	<result column="chg_bf_cnt" property="chg_bf_cnt"/>
    	<result column="chg_aft_cnt" property="chg_aft_cnt"/>
    	<result column="lst_upd_id" property="lst_upd_id"/>
    	<result column="lst_upd_dt" property="lst_upd_dt"/>
    	<result column="chg_bf_cd_nm" property="chg_bf_cd_nm"/>
    	<result column="chg_aft_cd_nm" property="chg_aft_cd_nm"/>
    	<result column="code_nm" property="code_nm"/>
    	<result column="code_cd" property="code_cd"/>
    	<result column="prt_nm" property="prt_nm"/>
    	<result column="prt_cd" property="prt_cd"/>
    	<result column="lst_upd_dt_time" property="lst_upd_dt_time"/>
	</resultMap>
	
	<!--
	<resultMap type="com.dowell.edu.vo.common.CodeMaterVO" id="CodeMaterVO">
    	<result column="code_cd" property="code_cd"/>
    	<result column="code_nm" property="code_nm"/>
   
	</resultMap>
	
	<resultMap type="com.dowell.edu.vo.common.CodeDetailVO" id="CodeDetailVO">
    	<result column="code_cd" property="code_cd"/>
    	<result column="dtl_cd" property="dtl_cd"/>
    	<result column="dtl_cd_nm" property="dtl_cd_nm"/>
   
	</resultMap>
	  -->
</mapper>